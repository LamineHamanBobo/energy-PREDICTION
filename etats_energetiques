# ======================================================
# CHAPITRE 3.1 ‚Äì √âTATS √âNERG√âTIQUES
# ======================================================

import os
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt


# ================================
# 1. CHARGEMENT DES DONN√âES
# ================================

DATA_DIR = "donnees_numeriques"
PRED_DIR = "predictions"

# Donn√©es historiques (r√©f√©rence seuils)
y_train = np.load(os.path.join(DATA_DIR, "y_train.npy")).flatten()

# Pr√©dictions multi-horizons
predictions = {
    "15_min": np.load(os.path.join(PRED_DIR, "predictions_15_min.npy")),
    "1_heure": np.load(os.path.join(PRED_DIR, "predictions_1_heure.npy")),
    "6_heures": np.load(os.path.join(PRED_DIR, "predictions_6_heures.npy")),
    "24_heures": np.load(os.path.join(PRED_DIR, "predictions_24_heures.npy")),
}

print("‚úî Donn√©es charg√©es avec succ√®s")


# ================================
# 2. CALCUL DES SEUILS √âNERG√âTIQUES
# ================================

low_threshold = np.percentile(y_train, 25)
normal_threshold = np.percentile(y_train, 50)
high_threshold = np.percentile(y_train, 75)

print("\nSeuils √©nerg√©tiques calcul√©s :")
print(f"Faible   < {low_threshold:.2f} kWh")
print(f"Normal  < {normal_threshold:.2f} kWh")
print(f"√âlev√©   < {high_threshold:.2f} kWh")
print(f"Critique ‚â• {high_threshold:.2f} kWh")


# ================================
# 3. FONCTION DE CLASSIFICATION DES √âTATS
# ================================

def energy_state(value):
    if value < low_threshold:
        return "Faible üü¢"
    elif value < normal_threshold:
        return "Normale üü°"
    elif value < high_threshold:
        return "√âlev√©e üü†"
    else:
        return "Critique üî¥"


# ================================
# 4. CALCUL DES √âTATS POUR CHAQUE HORIZON
# ================================

states_by_horizon = {}

for horizon, preds in predictions.items():
    states = [energy_state(v) for v in preds]
    states_by_horizon[horizon] = states
    print(f"‚úî √âtats calcul√©s pour {horizon}")


# ================================
# 5. MISE EN DATAFRAME
# ================================

energy_states_df = pd.DataFrame({
    horizon: states
    for horizon, states in states_by_horizon.items()
})

print("\nAper√ßu des √©tats √©nerg√©tiques :")
print(energy_states_df.head())


# ================================
# 6. VISUALISATION DES √âTATS (COMPTAGE)
# ================================

state_counts = energy_states_df.apply(pd.Series.value_counts)

state_counts.plot(kind="bar", figsize=(10, 5))
plt.title("Distribution des √©tats √©nerg√©tiques par horizon")
plt.ylabel("Nombre d'occurrences")
plt.show()


# ================================
# 7. SAUVEGARDE DES R√âSULTATS
# ================================

os.makedirs("etats_energetiques", exist_ok=True)

energy_states_df.to_csv(
    "etats_energetiques/energy_states_multi_horizon.csv",
    index=False
)

print("‚úî √âtats √©nerg√©tiques sauvegard√©s")
